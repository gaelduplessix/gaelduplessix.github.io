<html>
	<head>
		<title>Cloth Simulation</title>
		<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
				
		<link rel="stylesheet" href="css/style.css">
	</head>
	<body>
		<section id="container">            
		</section>
		<section id="infos">
			<h1>CSE 169 Final Project - Cloth Simulation</h1>
		</section>
		
		<!-- JS Libs -->
		<script type="text/javascript" src="js/lib/jquery-2.1.0.js"></script>
		<script type="text/javascript" src="js/lib/three.js"></script>
		<script type="text/javascript" src="js/lib/orbit-controls.js"></script>
		<script type="text/javascript" src="js/lib/transform-controls.js"></script>
		<script type="text/javascript" src="js/lib/dat.gui.min.js"></script>
		<script type="text/javascript" src="js/lib/stats.min.js"></script>
		
		<!-- Application -->
		<script type="text/javascript" src="js/spring-damper.js"></script>		
		<script type="text/javascript" src="js/cloth-geometry.js"></script>
		<script type="text/javascript" src="js/cloth.js"></script>		
		
		<script type="text/javascript">		
            var container, stats;

			var camera, orbitControl, scene, renderer;

            var materials = [];
            var plane, sphere, sphereControl;
			var cloth, air, gravity;
			var GUIControls;

			init();
			initControls();
			animate();

			function init() {			
			    // Renderer
				renderer = new THREE.WebGLRenderer({antialias: false, devicePixelsRation: 1});				
				renderer.setSize(window.innerWidth, window.innerHeight);
				
				container = document.getElementById('container');
				container.appendChild(renderer.domElement);				
				
			    // Camera
				camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 10000);				
				orbitControl = new THREE.OrbitControls(camera, renderer.domElement);
				orbitControl.maxDistance = 50;

				// world
				scene = new THREE.Scene();
				scene.fog = new THREE.FogExp2(0x424242, 0.02*0);
				renderer.setClearColor(scene.fog.color, 1);

                var planeTexture = THREE.ImageUtils.loadTexture('img/snow.jpg');
                planeTexture.wrapS = planeTexture.wrapT = THREE.RepeatWrapping; 
                planeTexture.repeat.set(1, 1);
				var planeMaterial =  new THREE.MeshPhongMaterial({color:0xffffff, wireframe: false, map: planeTexture});
				materials.push(planeMaterial);
				
				var clothTexture = THREE.ImageUtils.loadTexture('img/us-flag.jpg');
                clothTexture.wrapS = clothTexture.wrapT = THREE.RepeatWrapping; 
                clothTexture.repeat.set(1, 1);
				var clothMaterial =  new THREE.MeshPhongMaterial({
				    color:0xffffff,
				    wireframe: false,
				    side: THREE.DoubleSide,
				    map: clothTexture,
				    specular: new THREE.Color(0.2, 0.2, 0.2)
				});
				materials.push(clothMaterial);
				
				plane = new THREE.Mesh(new THREE.PlaneGeometry(100, 100, 20, 20), planeMaterial);
				plane.position.y = -5;
				plane.rotation.x = -Math.PI/2;
				plane.bounce = 0;
				plane.friction = 0.4;
				
				camera.position.y = 2 + plane.position.y;
				camera.position.z = 6;
				orbitControl.target.y = 2 + plane.position.y;
				
				scene.add(plane);

                // Cloth
				cloth = new Cloth(clothMaterial, camera, scene, renderer);
				//cloth.detach();
				scene.add(cloth);
				gravity = new THREE.Vector3();
				air = {
				    speed: new THREE.Vector3(1, 0.01, 0.01),
				    density: 1.2,
				    dragCoeff: 1.2
				};
				
				// Sphere
				var sphereTexture = THREE.ImageUtils.loadTexture('img/checkerboard.jpg');
				sphereTexture.wrapS = sphereTexture.wrapT = THREE.RepeatWrapping;
				sphereTexture.repeat.set(3, 3);
				var sphereMaterial = new THREE.MeshPhongMaterial({color:0xffffff, map: sphereTexture, specular: new THREE.Color(0.3, 0.3, 0.3)});
				materials.push(sphereMaterial);
				sphere = new THREE.Mesh(new THREE.SphereGeometry(0.5, 20, 20), sphereMaterial);
				sphere.position.set(0, -2, -0.7);
				sphere.position.y = -4;
				sphere.velocity = new THREE.Vector3();
				sphere.angularVelocity = new THREE.Vector3(0, 0.5, 0);
				sphere.mass = 0;
				sphere.bounce = 0;
				sphere.friction = 0.8;
				scene.add(sphere);
				
                sphereControl = new THREE.TransformControls(camera, renderer.domElement);
            	sphereControl.attach(sphere);
				
				// Add flag pole
				var poleMaterial = new THREE.MeshPhongMaterial({color: 0xffffff});
				materials.push(poleMaterial);
				var pole = new THREE.Mesh(new THREE.CylinderGeometry(0.02, 0.02, 5), poleMaterial);
				pole.position.set(-1, -3.5, 0);
				scene.add(pole);
				var poleHead = new THREE.Mesh(new THREE.SphereGeometry(0.02), poleMaterial);
				poleHead.position.set(-1, -1, 0);
				scene.add(poleHead);
				
				// lights
				light = new THREE.AmbientLight(0x222222);
				scene.add(light);
				
				light = new THREE.SpotLight(0xffffff);
				light.position.set(10, 10, 10);
				light.intensity = 1;
				scene.add(light);


                // Shadow maps
                renderer.shadowMapEnabled = true;
                
                light.shadowBias = 0.00001;
				light.shadowDarkness = 0.5;
				
				light.shadowCameraNear = 8;
				light.shadowCameraFar = 50;
				light.shadowMapWidth = 1024;
				light.shadowMapHeight = 1024;
				
                
                light.castShadow = true;
                sphere.castShadow = true;
                cloth.castShadow = true;
                pole.castShadow = true;
                sphere.receiveShadow = true;
                plane.receiveShadow = true;
                
				light = new THREE.PointLight(0xffffff);
				light.position.set(-10, 10, -10);
				light.intensity = 0.5;
				scene.add(light);                

				
				initCubemap();
								
				// Stats
				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				stats.domElement.style.zIndex = 100;
				container.appendChild(stats.domElement);

				window.addEventListener('resize', onWindowResize, false);
			}
			
			function initCubemap() {
                // Cubemap
                var path = "img/cubemaps/Park3Med/";
                var format = '.jpg';
                var urls = [
                    path + 'posx' + format, path + 'negx' + format,
                    path + 'posy' + format, path + 'negy' + format,
                    path + 'posz' + format, path + 'negz' + format
                ];

                var reflectionCube = THREE.ImageUtils.loadTextureCube( urls );
                reflectionCube.format = THREE.RGBFormat;

				// Skybox
                var shader = THREE.ShaderLib[ "cube" ];
                shader.uniforms[ "tCube" ].value = reflectionCube;

                var material = new THREE.ShaderMaterial( {
                    fragmentShader: shader.fragmentShader,
                    vertexShader: shader.vertexShader,
                    uniforms: shader.uniforms,
                    depthWrite: false,
                    side: THREE.BackSide
				});
				materials.push(material);

				var cubemapMesh = new THREE.Mesh(new THREE.BoxGeometry(150, 150, 150), material);
				scene.add(cubemapMesh);
			}

			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize(window.innerWidth, window.innerHeight);				
				render();
			}
			
            var prevTime;

			function animate() {
				requestAnimationFrame(animate);
				orbitControl.update();
				sphereControl.update();
				cloth.control.update();
				
				prevTime = prevTime || new Date().getTime();
				var
				    now = new Date().getTime(),
				    deltaTime = (now - prevTime) / 1000;
				;
				deltaTime = deltaTime > (50/1000) ? (50/1000) : deltaTime;
				
				// Animate sphere
				sphere.rotateOnAxis(sphere.angularVelocity, sphere.angularVelocity.length()*deltaTime);
				
				// Compute sphere speed
				if (sphere.oldPosition) {
    				sphere.velocity.copy(sphere.position).sub(sphere.oldPosition).divideScalar(deltaTime);
    				sphere.oldPosition.copy(sphere.position);
				} else {
    				sphere.oldPosition = new THREE.Vector3();
    				sphere.oldPosition.copy(sphere.position);
				}

				cloth.animate(deltaTime);
				render();
				prevTime = now;
			}

			function render() {
				renderer.render(scene, camera);
				stats.update();
			}
			
			function initControls() {
			
                // Cloth controls
                $(window).keydown(function (event) {
                    switch ( event.keyCode ) {
                        case 87: // W
                            cloth.control.setMode('translate');
                            break;
                        case 69: // E
                            cloth.control.setMode('rotate');
                            break;
    					case 187:
    					case 107: // +,=,num+
    						cloth.control.setSize( control.size + 0.1 );
    						break;
    					case 189:
    					case 10: // -,_,num-
    						cloth.control.setSize( Math.max(control.size - 0.1, 0.1 ) );
                            break;
                    }
                });
                
                // GUI
                GUIControls = {
                    // World
                    gravity: gravity.y,
                    windX: air.speed.x,
                    windY: air.speed.y,
                    windZ: air.speed.z,
                    // Controls
                    wireframe: false,
                    clothGizmo: false,
                    sphereGizmo: false,
                    sphereRotation: 0.5,
                    detach: function () {
                        cloth.detach();
                    }
                };
                
                $(function () {
                    var gui = new dat.GUI();
                    
                    var world = gui.addFolder('World');
                    world.add(GUIControls, 'gravity', -1, 1).onChange(function (value) {
                        gravity.set(0, -9.81, 0).multiplyScalar(value);
                    });
                    world.add(GUIControls, 'windX', -5, 5).onChange(function (value) {
                        air.speed.x = value;
                    });
                    world.add(GUIControls, 'windY', -5, 5).onChange(function (value) {
                        air.speed.y = value;
                    });
                    world.add(GUIControls, 'windZ', -5, 5).onChange(function (value) {
                        air.speed.z = value;
                    });

                    var controls = gui.addFolder('Controls');
                    controls.add(GUIControls, 'wireframe').onChange(function (value) {
                        var i, l;
                        
                        for (i = 0, l = materials.length; i < l; i += 1) {
                            materials[i].wireframe = value;
                        }
                    });
                    controls.add(GUIControls, 'clothGizmo').onChange(function (value) {
                        if (value) {
                            scene.add(cloth.control);
                        } else {
                            scene.remove(cloth.control);
                        }
                    });
                    controls.add(GUIControls, 'sphereGizmo').onChange(function (value) {
                        if (value) {
                            scene.add(sphereControl);
                        } else {
                            scene.remove(sphereControl);
                        }
                    });                    
                    controls.add(GUIControls, 'sphereRotation', -1, 1).onChange(function (value) {
                        sphere.angularVelocity.set(0, value, 0);
                    });
                    controls.add(GUIControls, 'detach');
                });

            }
		</script>
		
    </body>
</html>